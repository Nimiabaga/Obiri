<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin — OBÍRÍ | Toggle Availability</title>
  <meta name="robots" content="noindex,nofollow">
  <link rel="stylesheet" href="style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>
  <style>
    body{
      background:#000 url('images/bg-admin.jpg') center / cover no-repeat fixed;
      color:#f2f2f2;
    }
    .avail-main{ max-width:540px; margin:2.5em auto; padding:1.7em 1.3em 2.5em; background:rgba(0,0,0,0.78); border-radius:18px;}
    h2{ text-align:center; margin-bottom:1.45em; color:#fff;}
    .avail-list{margin:0; padding:0;}
    .avail-row{
      display:flex; justify-content:space-between; align-items:center;
      border-bottom:1px solid #222; padding:1em 0; font-size:1.11em;
    }
    .avail-row:last-child{border-bottom:none;}
    .unavailable{ opacity:0.45; text-decoration:line-through;}
    .avail-label{display:block;color:#dbc06c;font-size:0.98em;margin-bottom:2px;}
    .soldout-btn{
      background:#c1121f; color:#fff; font-weight:900; border:none; border-radius:20px;
      padding:0.44em 1.2em; font-size:1em; cursor:pointer; margin-left:1.2em;
      transition:background 0.14s;}
    .soldout-btn:hover{background:#920d17;}
    .adm-btn{margin:2em auto 0;display:block;padding:.7em 1.5em;border-radius:999px;font-weight:900;letter-spacing:.02em;text-decoration:none; background:linear-gradient(180deg,#fff,#eaeaea);color:#222;}
    select {
      width:100%;max-width:320px;display:block;margin:0 auto 1.2em  ;font-size:1.04em;padding:.6em;border-radius:.7em;
    }
  </style>
</head>
<body>
  <div class="avail-main">
    <h2>Toggle Availability</h2>
    <!-- Filter dropdown -->
    <select id="filterType">
      <option value="">Show: All</option>
      <option value="Drinks">Drinks Only</option>
      <option value="Food">Food Only</option>
    </select>
    <div id="avail-list" class="avail-list"></div>
    <a href="admin.html" class="adm-btn">Back to Admin</a>
  </div>
  <script>
    // UPDATED ENDPOINT to your deployed web app URL
    const ENDPOINT = 'https://script.google.com/macros/s/AKfycbxvsocRF4Pgv1cXB6RoEH7diqohK05MErMnFgN5vYZD1vk6gtcSWpCl8EwHCUG9_x2yiw/exec';
    const TOKEN = 'Forgive1988@';

    function formatNaira(amount) {
      if(!amount || isNaN(amount)) return '₦0';
      return '₦' + Number(amount).toLocaleString();
    }

    async function loadMenu() {
      const res = await fetch(`${ENDPOINT}?token=${TOKEN}`);
      const json = await res.json();
      if(!json.ok) return [];
      return json.rows;
    }

    async function renderList() {
      const items = await loadMenu();
      const filterType = document.getElementById('filterType').value;
      const container = document.getElementById('avail-list');
      container.innerHTML = "";

      // Filter items by the dropdown value
      const filtered = !filterType ? items : items.filter(x => x.type === filterType);

      filtered.sort((a, b) => a.type.localeCompare(b.type) || a.name.localeCompare(b.name));
      for(const item of filtered) {
        const row = document.createElement('div');
        row.className = "avail-row" + (item.available !== true ? " unavailable" : "");
        row.innerHTML = `
          <span>
            <span class="avail-label">${item.type} &mdash; ${item.cat}</span>
            <strong>${item.name}</strong> • ${formatNaira(item.price)}
          </span>
          ${item.available === true ? `<button class="soldout-btn" data-id="${item.id}">Sold Out</button>` : `<span style="color:#d91e1e;font-weight:bold;margin-left:1.3em;">Sold Out</span>`}
        `;
        container.appendChild(row);
      }
    }

    // Filter dropdown event
    document.getElementById('filterType').addEventListener('change', renderList);

    // Sold out button logic
    document.addEventListener('click', async function(e){
      if(e.target.classList.contains('soldout-btn')) {
        const id = e.target.getAttribute('data-id');
        e.target.textContent = "Please wait...";
        e.target.disabled = true;
        // Send update to Google Sheets backend
        const res = await fetch(`${ENDPOINT}?token=${TOKEN}`, {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ id: id, available: false })
        });
        const json = await res.json();
        if(json.ok){
          renderList();
        } else {
          alert("Failed to update. Try again!");
          e.target.textContent = "Sold Out";
          e.target.disabled = false;
        }
      }
    });

    // Initial render on load
    renderList();
  </script>
</body>
</html>
